#!/usr/bin/env python3
import re, math
from pwn import remote
from itertools import combinations

HOST = "172.18.0.51"
PORT = 1337

# ✅ FIX 1: ของจริงเป็น "N = ..." ตัวใหญ่
RE_N = re.compile(rb"\bN\s*=\s*(\d+)")
RE_E = re.compile(rb"\be\s*=\s*(\d+)")
# ✅ FIX 1: ของจริงเป็น "c = ..." (ไม่ใช่ cipher)
RE_C = re.compile(rb"\bc\s*=\s*(\d+)")

def grab_params():
    io = remote(HOST, PORT)

    # ✅ FIX 2: รอ banner ให้ออกมาครบ (มันมี "Generating RSA Keypair... please wait.")
    # รอจนเจอบรรทัด "c =" แล้วอ่านเลขต่อ
    data = io.recvuntil(b"c = ", timeout=20)
    data += io.recvline(timeout=20)
    # อ่านต่ออีกนิดกันพลาด (บรรทัด oracle)
    data += io.recvrepeat(1.0)

    io.close()

    n = RE_N.search(data)
    e = RE_E.search(data)
    c = RE_C.search(data)

    n = int(n.group(1)) if n else None
    e = int(e.group(1)) if e else None
    c = int(c.group(1)) if c else None
    return n, e, c, data

def invmod(a, m):
    return pow(a, -1, m)

def rsa_decrypt(c, p, q, e):
    phi = (p-1)*(q-1)
    d = invmod(e, phi)
    return pow(c, d, p*q)

def iroot(k, n):
    x = int(k ** (1.0/n))
    while pow(x+1, n) <= k: x += 1
    while pow(x, n) > k: x -= 1
    return x

def to_bytes(m):
    hx = hex(m)[2:]
    if len(hx) % 2: hx = "0"+hx
    return bytes.fromhex(hx)

def main():
    samples = []
    print("[*] Collecting sessions...")
    for i in range(12):
        n,e,c,raw = grab_params()
        if n is None:
            print("[!] Still could not find N in output. Dumping first 500 bytes:")
            print(raw[:500])
            return
        samples.append((n,e,c))
        print(f"  - #{i}: n bits={n.bit_length()} e={e} c={'yes' if c else 'no'}")

    print("[*] Checking gcd for shared primes...")
    for (i,(n1,e1,c1)), (j,(n2,e2,c2)) in combinations(list(enumerate(samples)), 2):
        g = math.gcd(n1, n2)
        if g != 1 and g != n1 and g != n2:
            p = g
            q1 = n1 // p
            print(f"[+] Found shared prime! sessions {i} and {j}")
            print(f"    p = {p}")
            print(f"    q1 = {q1}")
            if c1 is not None and e1 is not None:
                m = rsa_decrypt(c1, p, q1, e1)
                pt = to_bytes(m)
                print("[+] Decrypted bytes:", pt[:200])
            return

    print("[*] Trying small-e integer root on any sample with c...")
    for n,e,c in samples:
        if c is None or e is None:
            continue
        if e in (3,5,7):
            r = iroot(c, e)
            if pow(r, e) == c:
                pt = to_bytes(r)
                print("[+] Perfect root found! plaintext bytes:", pt[:200])
                return

    print("[-] No hit yet. This service looks like an oracle challenge (not gcd/small-e).")

if __name__ == "__main__":
    main()

a = [25878775379916435970897911104324117011006856760361385819116931899733001450833, 80292504581484214867800448510497344370694961901882526138924856200258642618361, 54562238650714819533763937187273563560029710750904462184907724564346158140237, 30834807956188148036270093508097216410621697681321734280271104176585008500456, 62699684483843141568821365860334495449364228379122394000543140473229327277268, 78207264600798604784668231336291848862236269004769436790862484500415928989233, 61417271296138856704444105651561631254482458731849465466848003479195624991332, 39937245641764977558584951490518070678474274091308961369952432106010903535581, 38840641703645792586373613762052229232815967606884076814152959685214886495381, 106740693940193141087893003657868987966417298694068666845343648046356574018689, 84743061018383714495137289810083081324263004537030634309927940263900468997111, 60806278246354397068527026819371363502195727128451701780855521638296657163922, 39960632873186522641770985852864535176576237112918474308248535474701166932931, 64097163643660178065067139576763334088517224523390803621183172429724677431846, 114285133027270613079875181422794118922554967703167331779563904995170090033805, 89061601538980392180929072852258031870518511326072129517735508403732034503071, 109497245880107084551239056716563802855562585933614126324442322075603482993725, 63686954458072496910992201940932436481031938259424088432500824699653622316043, 100021623353561096459011931417514895295293439030681436367848867818327915003133, 114883990787912260454580419517456004259956645261473795279802857393219605918831, 71653771037370527186419961635116034068896374440180051189487380964719883267110, 91607645087989905993449554235941372492014761353844722410704930252180010806519, 28395936728383531129150159461256196090515745737460852339412603246679200310093, 78744580212206133101659179363885190682622412373183208856460085304775473217763, 775850249176581667952089839616870699525342651195058641544334315836518313201, 106589428030803202052170642987471602626322042957726190127628910207624491687876, 82971573736802740565553026442301125456963760676329174924439049281151933283911] c = 191525132692896166687925155732812051740711134546718181351363049498750742851036131